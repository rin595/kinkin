<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardew Logbook - å”ä½œç‰ˆæ—¥èªŒ (æœ€çµ‚ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Stardew Palette */
            --stardew-green: #4c7c34;
            --stardew-brown: #a0785a;
            --stardew-light-brown: #cfc29c;
            --stardew-cream: #fcfbe7;
            --stardew-dark: #2a2a2a;
            --stardew-red: #c94c4c;
            --stardew-gold: #ffc300;
            --stardew-blue: #5b7999; /* LL çš„é¡è‰² */
            --stardew-pink: #cc99a3; /* KK çš„é¡è‰² */
            --pixel-size: 2px;
            --page-width: 800px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            image-rendering: pixelated;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--stardew-green);
            background-image: repeating-linear-gradient(45deg, var(--stardew-green) 0, var(--stardew-green) 10px, var(--stardew-dark) 10px, var(--stardew-dark) 11px),
                              repeating-linear-gradient(-45deg, var(--stardew-green) 0, var(--stardew-green) 10px, var(--stardew-dark) 10px, var(--stardew-dark) 11px);
            background-size: 20px 20px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            color: var(--stardew-dark);
        }

        /* --- æ›¸æœ¬å®¹å™¨ (Wrapper) --- */
        .journal-window {
            width: var(--page-width);
            height: 90vh;
            background-color: var(--stardew-cream);
            padding: 20px;
            position: relative;
            overflow: hidden;

            border: calc(var(--pixel-size) * 4) solid var(--stardew-brown);
            box-shadow:
                calc(var(--pixel-size) * 4) calc(var(--pixel-size) * 4) 0 0 var(--stardew-dark),
                calc(var(--pixel-size) * 8) calc(var(--pixel-size) * 8) 0 0 var(--stardew-light-brown),
                inset 0 0 0 2px var(--stardew-light-brown);
        }

        /* --- è¦–åœ–åˆ‡æ›å™¨ (ç”¨æ–¼å‹•ç•«) --- */
        #view-switcher {
             position: relative;
             height: calc(100% - 70px);
             perspective: 1500px;
        }

        #view-switcher > div {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            padding: 20px;
            background-color: var(--stardew-cream);
            transition: transform 0.6s ease-in-out, opacity 0.6s ease-in-out;
            transform-origin: left;
            overflow-y: auto;
            backface-visibility: hidden;
        }

        .view-hidden {
            opacity: 0;
            z-index: 10;
            pointer-events: none;
            transform: rotateY(-90deg);
        }

        .view-active {
            opacity: 1;
            z-index: 20;
            pointer-events: all;
            transform: rotateY(0deg);
        }

        /* --- é ‚éƒ¨ç‹€æ…‹æ¬„ --- */
        .stat-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: var(--pixel-size) solid var(--stardew-dark);
        }

        /* è¨­å®šæŒ‰éˆ• */
        .settings-btn {
            background-color: var(--stardew-light-brown);
            color: var(--stardew-dark);
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            border: var(--pixel-size) solid var(--stardew-dark);
            box-shadow: 2px 2px 0 0 var(--stardew-dark);
            transition: all 0.1s;
        }
        .settings-btn:hover {
             background-color: var(--stardew-gold);
             transform: translate(-1px, -1px);
        }

        .love-value {
            font-size: 10px;
            background: var(--stardew-pink);
            padding: 4px 8px;
            color: #fff;
            border: var(--pixel-size) solid var(--stardew-dark);
            box-shadow: 2px 2px 0 0 var(--stardew-dark);
        }
        .stat-item { display: flex; align-items: center; font-size: 10px; }
        .stat-icon { font-size: 18px; margin-right: 5px; }

        /* --- æ—¥æ›†ç›¸é—œæ¨£å¼ (ç¶­æŒä¸è®Š) --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-size: 10px; }
        .day-header { text-align: center; color: var(--stardew-brown); padding: 5px; }
        .day-cell { height: 80px; padding: 5px; text-align: right; cursor: pointer; position: relative; background-color: #fff; border: var(--pixel-size) solid var(--stardew-light-brown); box-shadow: 1px 1px 0 0 var(--stardew-light-brown); transition: background-color 0.1s, transform 0.1s; }
        .day-cell:not(.empty-cell):hover { background-color: var(--stardew-gold); transform: translate(-1px, -1px); }
        .empty-cell { background-color: #f0f0f0; cursor: default; border: none; box-shadow: none; }
        .has-entry { background-color: var(--stardew-pink); color: #fff; font-weight: bold; }
        .day-cell .count { position: absolute; top: 5px; left: 5px; font-size: 8px; background: rgba(0,0,0,0.2); padding: 1px 3px; border-radius: 2px; }

        /* --- æ—¥æ›†å°èˆªæŒ‰éˆ•æ¨£å¼ --- */
        .calendar-nav-btn { background: var(--stardew-brown); color: var(--stardew-cream); padding: 2px 5px; font-size: 8px; border: var(--pixel-size) solid var(--stardew-dark); box-shadow: 1px 1px 0 0 var(--stardew-dark); cursor: pointer; margin: 0 10px; display: inline-block; vertical-align: middle; }
        .calendar-nav-btn:hover { background: var(--stardew-gold); color: var(--stardew-dark); }
        #current-month-year { font-size: 14px; color: var(--stardew-brown); margin-top: 5px; display: flex; justify-content: center; align-items: center; }

        /* --- å–®æ—¥é é¢ --- */
        #day-view { padding-bottom: 50px; }
        #day-title { font-size: 14px; text-align: center; margin-bottom: 20px; color: var(--stardew-dark); border-bottom: var(--pixel-size) solid var(--stardew-dark); padding-bottom: 10px; }
        .back-btn { position: absolute; top: 25px; left: 25px; font-size: 10px; cursor: pointer; padding: 5px; background: var(--stardew-light-brown); border: var(--pixel-size) solid var(--stardew-dark); box-shadow: 2px 2px 0 0 var(--stardew-dark); z-index: 30; }
        .timeline-content { display: flex; flex-direction: column; gap: 20px; padding-top: 20px; }

        /* --- æ ¸å¿ƒï¼šèŠå¤©æ°£æ³¡æ¨£å¼ (åˆªé™¤æŒ‰éˆ•ç­‰ç¶­æŒä¸è®Š) --- */
        .memory-entry { width: 70%; padding: 15px; margin-bottom: 10px; transition: all 0.3s; position: relative; border: var(--pixel-size) solid var(--stardew-dark); box-shadow: var(--pixel-size) var(--pixel-size) 0 0 var(--stardew-dark); }
        .author-LL { margin-right: auto; background-color: var(--stardew-blue); color: #fff; }
        .author-KK { margin-left: auto; background-color: var(--stardew-pink); color: var(--stardew-dark); }
        .entry-header { font-size: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: var(--pixel-size) dashed rgba(255, 255, 255, 0.4); }

        .delete-btn { background-color: rgba(255, 0, 0, 0.7); color: #fff; font-size: 8px; padding: 2px 5px; margin-left: 10px; border: var(--pixel-size) solid var(--stardew-dark); cursor: pointer; box-shadow: 1px 1px 0 0 var(--stardew-dark); transition: background-color 0.1s; line-height: 1; }
        .author-KK .delete-btn { background-color: rgba(150, 0, 0, 0.7); }
        .delete-btn:hover { background-color: darkred; box-shadow: 2px 2px 0 0 var(--stardew-dark); }

        /* --- Modal & Form Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 100; }
        .crafting-menu { width: 500px; background-color: var(--stardew-cream); padding: 30px; border: calc(var(--pixel-size) * 4) solid var(--stardew-brown); box-shadow: calc(var(--pixel-size) * 4) calc(var(--pixel-size) * 4) 0 0 var(--stardew-dark), calc(var(--pixel-size) * 8) calc(var(--pixel-size) * 8) 0 0 var(--stardew-light-brown); }

        .btn-pixel { background-color: var(--stardew-light-brown); color: var(--stardew-dark); padding: 8px 12px; font-size: 10px; cursor: pointer; border: var(--pixel-size) solid var(--stardew-dark); box-shadow: 2px 2px 0 0 var(--stardew-dark); transition: all 0.1s; }
        .btn-pixel:hover { background-color: var(--stardew-gold); color: var(--stardew-dark); box-shadow: 3px 3px 0 0 var(--stardew-dark); transform: translate(-1px, -1px); }
        .btn-pixel:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0 0 var(--stardew-dark); }
        .add-btn { position: fixed; bottom: 30px; right: 30px; width: 120px; height: 40px; line-height: 20px; text-align: center; background-color: var(--stardew-gold); color: var(--stardew-dark); cursor: pointer; z-index: 50; }

        /* è¨­å®š Modal å°ˆç”¨æ¨£å¼ */
        .setting-option {
            padding: 15px;
            border: var(--pixel-size) solid var(--stardew-dark);
            background-color: #fff;
            margin-bottom: 10px;
        }
        .setting-option p {
            font-size: 8px;
            color: var(--stardew-dark);
            line-height: 1.4;
            margin-bottom: 10px;
        }
        .setting-option h3 {
            font-size: 12px;
            margin-top: 0;
            color: var(--stardew-brown);
        }
        .setting-option input[type="file"] {
            display: none;
        }
        .file-upload-btn {
            background-color: var(--stardew-blue);
            color: #fff;
            padding: 8px 12px;
            font-size: 10px;
            cursor: pointer;
            border: var(--pixel-size) solid var(--stardew-dark);
            box-shadow: 2px 2px 0 0 var(--stardew-dark);
            display: inline-block;
            margin-top: 5px;
        }
        .file-upload-btn:hover {
            background-color: #4a6785;
        }

    </style>
</head>
<body>

    <div class="journal-window">

        <div class="stat-bar">
             <button class="settings-btn" onclick="openSettingsModal()">âš™ï¸ SETTINGS</button> <div class="love-value" id="love-value">
                â¤ï¸ LOVE: 0
            </div>
            <div class="stat-item">
                <span class="stat-icon">ğŸ“…</span>
                <span style="font-size: 8px;" id="current-date"></span>
            </div>
        </div>

        <div id="view-switcher">

            <div id="calendar-view" class="view-active">
                <header style="text-align: center; margin-bottom: 30px;">
                    <h1 style="font-size: 20px; margin: 0; color: var(--stardew-dark);">CALENDAR</h1>
                    <div id="current-month-year"></div>
                </header>
                <div class="calendar-grid" id="calendar-grid">
                    </div>
            </div>

            <div id="day-view" class="view-hidden">
                <button class="back-btn" onclick="navigateTo('calendar')">â† BACK</button>
                <h2 id="day-title"></h2>
                <div class="timeline-content" id="day-timeline-content">
                    </div>
            </div>

        </div>

    </div>

    <button class="add-btn btn-pixel" onclick="openForm()">+ New Log</button>

    <div class="modal-overlay" id="crafting-modal">
        <div class="crafting-menu">
            <h2>CRAFT NEW ENTRY</h2>
            <form id="entry-form">

                <div class="form-row">
                    <div class="form-group"><label for="entry-author">RECORDER (è¨˜äº‹äºº)</label><select id="entry-author" required><option value="LL">LL</option><option value="KK">KK</option></select></div>
                    <div class="form-group"><label for="entry-date">DATE (æ—¥æœŸ)</label><input type="date" id="entry-date" required></div>
                </div>

                <div class="form-row">
                    <div class="form-group"><label for="entry-weather">WEATHER (å¤©æ°£)</label><select id="entry-weather" required><option value="â˜€ï¸">Sunny Day â˜€ï¸</option><option value="ğŸŒ§ï¸">Rainy Day ğŸŒ§ï¸</option><option value="ğŸ’¨">Windy Day ğŸ’¨</option><option value="â„ï¸">Snowy Day â„ï¸</option></select></div>
                    <div class="form-group"><label for="entry-type">ENTRY TYPE (é¡å‹)</label><select id="entry-type" required><option value="text">Mood/Text Log (æ–‡å­—)</option><option value="photo">Photo Memory (åœ–ç‰‡)</option></select></div>
                </div>

                <div class="form-group"><label for="entry-title">TITLE / SHORT CAPTION (æ¨™é¡Œ)</label><input type="text" id="entry-title" required maxlength="50"></div>
                <div class="form-group"><label for="entry-content">MAIN CONTENT (ä¸»è¦å…§å®¹)</label><textarea id="entry-content" required></textarea></div>

                <div class="form-group" id="file-upload-group">
                    <label for="entry-image">ATTACH PHOTO (å¯é¸åœ–ç‰‡)</label>
                    <label for="entry-image" class="custom-file-upload" id="file-label">CLICK TO SELECT FILE ğŸ“·</label>
                    <input type="file" id="entry-image" accept="image/*">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-pixel" onclick="closeForm()">CLOSE</button>
                    <button type="submit" class="btn-pixel" style="background-color: var(--stardew-green); color:#fff;">LOG IT!</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="crafting-menu" style="width: 450px;">
            <h2>SETTINGS / DATA TRANSFER</h2>

            <div class="setting-option">
                <h3>EXPORT LOGS (åŒ¯å‡ºæ—¥èªŒ)</h3>
                <p>å°‡æ‰€æœ‰æ—¥èªŒå…§å®¹æ‰“åŒ…æˆä¸€å€‹ `.json` æª”æ¡ˆã€‚é€™æ˜¯æ‚¨èˆ‡å”ä½œè€…å…±äº«é€²åº¦çš„æ–¹å¼ã€‚</p>
                <button class="btn-pixel" style="background-color: var(--stardew-gold); color: var(--stardew-dark);" onclick="exportLogs()">DOWNLOAD .JSON</button>
            </div>

            <div class="setting-option">
                <h3>IMPORT LOGS (åŒ¯å…¥æ—¥èªŒ)</h3>
                <p>ä¸Šå‚³ä¸€å€‹ `.json` æª”æ¡ˆä¾†è¦†è“‹æœ¬åœ°å„²å­˜çš„æ—¥èªŒã€‚**è­¦å‘Šï¼šé€™å°‡å–ä»£æ‚¨æ‰€æœ‰çš„æœ¬åœ°ç´€éŒ„ï¼**</p>
                <input type="file" id="import-file-input" accept=".json">
                <label for="import-file-input" class="file-upload-btn">
                    UPLOAD & IMPORT FILE
                </label>
            </div>

            <div class="setting-option">
                <h3>WIPE ALL DATA (æ¸…é™¤æ•¸æ“š)</h3>
                <p>å¦‚æœæ‚¨æƒ³å¾é ­é–‹å§‹æˆ–æ¸…ç†æœ¬åœ°å„²å­˜ï¼Œè«‹é»æ“Šæ­¤è™•ã€‚**æ­¤æ“ä½œä¸å¯é€†ï¼**</p>
                <button class="btn-pixel" style="background-color: var(--stardew-red); color: #fff;" onclick="wipeData()">WIPE LOCAL DATA</button>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-pixel" onclick="closeSettingsModal()">CLOSE</button>
            </div>
        </div>
    </div>


    <script>
        // --- Setup & Global Variables ---
        const MODAL = document.getElementById('crafting-modal');
        const SETTINGS_MODAL = document.getElementById('settings-modal');
        const FORM = document.getElementById('entry-form');
        const CALENDAR_GRID = document.getElementById('calendar-grid');
        const DAY_TIMELINE = document.getElementById('day-timeline-content');
        const CALENDAR_VIEW = document.getElementById('calendar-view');
        const DAY_VIEW = document.getElementById('day-view');

        const FILE_INPUT = document.getElementById('entry-image');
        const FILE_LABEL = document.getElementById('file-label');
        const IMPORT_FILE_INPUT = document.getElementById('import-file-input');

        const STORAGE_KEY = 'stardewFarmLogEntriesV2';
        let allEntries = [];
        const LOVE_VALUE_PER_ENTRY = 5;

        let currentDisplayYear;
        let currentDisplayMonth;


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            currentDisplayYear = today.getFullYear();
            currentDisplayMonth = today.getMonth();

            document.getElementById('current-date').textContent = getFormattedDate(today, 'YYYY/MM/DD');
            loadAndRenderAll();
            navigateTo('calendar');

            // ç¶å®šåŒ¯å…¥äº‹ä»¶
            IMPORT_FILE_INPUT.addEventListener('change', importLogs);
        });

        function loadAndRenderAll() {
            allEntries = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            calculateLoveValue();
            renderCalendar();
        }

        function calculateLoveValue() {
            const totalLove = allEntries.length * LOVE_VALUE_PER_ENTRY;
            document.getElementById('love-value').textContent = `â¤ï¸ LOVE: ${totalLove}`;
        }

        // --- è¦–åœ–åˆ‡æ›èˆ‡å°èˆª (ç¶­æŒä¸è®Š) ---
        function navigateTo(view, dateStr = null) {
            if (view === 'day' && dateStr) {
                renderDayView(dateStr);
                CALENDAR_VIEW.classList.remove('view-active');
                CALENDAR_VIEW.classList.add('view-hidden');
                DAY_VIEW.classList.remove('view-hidden');
                DAY_VIEW.classList.add('view-active');

            } else if (view === 'calendar') {
                const today = new Date();
                document.getElementById('current-date').textContent = getFormattedDate(today, 'YYYY/MM/DD');

                currentDisplayYear = today.getFullYear();
                currentDisplayMonth = today.getMonth();
                renderCalendar();

                DAY_VIEW.classList.remove('view-active');
                DAY_VIEW.classList.add('view-hidden');
                CALENDAR_VIEW.classList.remove('view-hidden');
                CALENDAR_VIEW.classList.add('view-active');
            }
        }

        function prevMonth() { currentDisplayMonth--; if (currentDisplayMonth < 0) { currentDisplayMonth = 11; currentDisplayYear--; } renderCalendar(); }
        function nextMonth() { currentDisplayMonth++; if (currentDisplayMonth > 11) { currentDisplayMonth = 0; currentDisplayYear++; } renderCalendar(); }
        window.prevMonth = prevMonth;
        window.nextMonth = nextMonth;

        function renderCalendar() {
            const year = currentDisplayYear;
            const month = currentDisplayMonth;

            const entriesByDate = allEntries.reduce((acc, entry) => {
                const dateKey = entry.dateStr;
                if (!acc[dateKey]) acc[dateKey] = 0;
                acc[dateKey]++;
                return acc;
            }, {});

            document.getElementById('current-month-year').innerHTML = `
                <button class="calendar-nav-btn" onclick="prevMonth()">â†</button>
                ${year} / ${month + 1}
                <button class="calendar-nav-btn" onclick="nextMonth()">â†’</button>
            `;

            CALENDAR_GRID.innerHTML = '';

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfWeek = new Date(year, month, 1).getDay();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            dayNames.forEach(day => { const header = document.createElement('div'); header.className = 'day-header'; header.textContent = day; CALENDAR_GRID.appendChild(header); });
            for (let i = 0; i < firstDayOfWeek; i++) { const empty = document.createElement('div'); empty.className = 'empty-cell'; CALENDAR_GRID.appendChild(empty); }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateKey = getFormattedDate(date, 'YYYY-MM-DD');
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.textContent = day;
                cell.dataset.date = dateKey;

                if (entriesByDate[dateKey]) {
                    cell.classList.add('has-entry');
                    const countSpan = document.createElement('span');
                    countSpan.className = 'count';
                    countSpan.textContent = `${entriesByDate[dateKey]} Log${entriesByDate[dateKey] > 1 ? 's' : ''}`;
                    cell.appendChild(countSpan);
                }

                cell.onclick = (function(key) { return function() { navigateTo('day', key); }; })(dateKey);
                CALENDAR_GRID.appendChild(cell);
            }
        }

        function renderDayView(dateStr) {
            document.getElementById('day-title').textContent = `LOGS FOR ${dateStr}`;
            DAY_TIMELINE.innerHTML = '';
            const dateObj = new Date(dateStr + 'T00:00:00');
            document.getElementById('current-date').textContent = getFormattedDate(dateObj, 'YYYY/MM/DD');

            const dayEntries = allEntries.filter(e => e.dateStr === dateStr)
                                       .sort((a, b) => b.id - a.id);

            if (dayEntries.length === 0) {
                DAY_TIMELINE.innerHTML = '<p style="text-align:center; font-size:10px; padding-top: 50px;">NO ENTRIES FOR THIS DATE. BE THE FIRST TO LOG!</p>';
                return;
            }

            dayEntries.forEach(entry => {
                DAY_TIMELINE.appendChild(createEntryElement(entry));
            });
        }

        // --- åˆªé™¤åŠŸèƒ½ ---
        function deleteEntry(id, dateStr) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™æ¢æ—¥èªŒå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚")) { return; }
            allEntries = allEntries.filter(entry => entry.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allEntries));
            calculateLoveValue();
            renderDayView(dateStr);
            renderCalendar();
        }
        window.deleteEntry = deleteEntry;


        // --- è¡¨å–®é‚è¼¯ (ç¶­æŒä¸è®Š) ---
        function openForm() { MODAL.style.display = 'flex'; FORM.reset(); FILE_LABEL.textContent = 'CLICK TO SELECT FILE ğŸ“·'; document.getElementById('entry-date').value = new Date().toISOString().split('T')[0]; }
        function closeForm() { MODAL.style.display = 'none'; }
        FILE_INPUT.addEventListener('change', (e) => { FILE_LABEL.textContent = e.target.files.length > 0 ? `File Selected: ${e.target.files[0].name}` : 'CLICK TO SELECT FILE ğŸ“·'; });

        FORM.addEventListener('submit', async (e) => {
            e.preventDefault();
            const dateInput = document.getElementById('entry-date').value;
            const file = FILE_INPUT.files[0];
            let imageDataURL = null;
            if (file) { imageDataURL = await fileToBase64(file); }

            const newEntry = {
                id: Date.now(), author: document.getElementById('entry-author').value, dateStr: dateInput, date: getFormattedDate(new Date(dateInput), 'YYYY/MM/DD'), weather: document.getElementById('entry-weather').value, title: document.getElementById('entry-title').value, content: document.getElementById('entry-content').value, type: document.getElementById('entry-type').value, imageDataURL: imageDataURL,
            };
            saveEntry(newEntry);
            loadAndRenderAll();
            navigateTo('day', newEntry.dateStr);
            closeForm();
        });

        function saveEntry(newEntry) {
            allEntries.push(newEntry);
            allEntries.sort((a, b) => a.id - b.id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allEntries));
        }


        // --- æ ¸å¿ƒï¼šåŒ¯å‡º/åŒ¯å…¥/æ¸…é™¤ åŠŸèƒ½ ---

        function openSettingsModal() { SETTINGS_MODAL.style.display = 'flex'; }
        function closeSettingsModal() { SETTINGS_MODAL.style.display = 'none'; }
        window.openSettingsModal = openSettingsModal;

        // åŒ¯å‡ºæ—¥èªŒç‚º JSON æª”æ¡ˆ
        function exportLogs() {
            const data = JSON.stringify(allEntries, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            const date = getFormattedDate(new Date(), 'YYYY-MM-DD');
            a.download = `stardew_log_export_${date}.json`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("æ—¥èªŒå·²æˆåŠŸåŒ¯å‡ºç‚º JSON æª”æ¡ˆï¼è«‹å°‡æ­¤æª”æ¡ˆç™¼é€çµ¦æ‚¨çš„å”ä½œè€…ã€‚");
        }
        window.exportLogs = exportLogs;

        // åŒ¯å…¥æ—¥èªŒ (å¾ JSON æª”æ¡ˆ)
        function importLogs(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("ç¢ºå®šè¦åŒ¯å…¥æ–°çš„æ—¥èªŒå—ï¼Ÿç¾æœ‰çš„æœ¬åœ°ç´€éŒ„å°‡æœƒè¢«æ–°çš„æª”æ¡ˆæ•¸æ“šè¦†è“‹ã€‚")) {
                event.target.value = null; // é‡ç½® input è®“ç”¨æˆ¶å¯ä»¥é‡æ–°é¸æ“‡åŒä¸€å€‹æª”æ¡ˆ
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // ç°¡æ˜“é©—è­‰
                    if (Array.isArray(importedData) && (importedData.length === 0 || (importedData[0].id && importedData[0].dateStr))) {

                        // è¦†è“‹æœ¬åœ°æ•¸æ“š
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));

                        // é‡æ–°è¼‰å…¥ä¸¦æ¸²æŸ“
                        loadAndRenderAll();

                        closeSettingsModal();
                        alert(`æ—¥èªŒæˆåŠŸåŒ¯å…¥ï¼å…±è¼‰å…¥ ${importedData.length} æ¢ç´€éŒ„ã€‚`);
                    } else {
                        alert("éŒ¯èª¤ï¼šåŒ¯å…¥çš„æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ç¢ºèªæ‚¨åŒ¯å…¥çš„æ˜¯æ­£ç¢ºçš„æ—¥èªŒ JSON æª”æ¡ˆã€‚");
                    }
                } catch (error) {
                    console.error("Error parsing JSON:", error);
                    alert("éŒ¯èª¤ï¼šè®€å–æª”æ¡ˆå¤±æ•—æˆ– JSON æ ¼å¼ç„¡æ•ˆã€‚");
                } finally {
                    event.target.value = null; // é‡ç½® input
                }
            };
            reader.onerror = function(e) {
                alert("éŒ¯èª¤ï¼šè®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
                event.target.value = null;
            };

            reader.readAsText(file);
        }

        // æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•¸æ“š
        function wipeData() {
            if (!confirm("è­¦å‘Šï¼šæ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰çš„æœ¬åœ°æ—¥èªŒæ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰ç´€éŒ„ï¼Œç„¡æ³•å¾©åŸï¼è«‹ç¢ºèªæ‚¨å·²åŒ¯å‡ºå‚™ä»½ã€‚")) {
                return;
            }
            localStorage.removeItem(STORAGE_KEY);
            allEntries = [];
            loadAndRenderAll();
            navigateTo('calendar');
            closeSettingsModal();
            alert("æœ¬åœ°æ—¥èªŒæ•¸æ“šå·²å®Œå…¨æ¸…é™¤ã€‚æ‚¨å¯ä»¥é–‹å§‹æ–°çš„ç´€éŒ„æˆ–åŒ¯å…¥å‚™ä»½ã€‚");
        }
        window.wipeData = wipeData;

        // --- Rendering Templates & Utilities (ç¶­æŒä¸è®Š) ---
        function createEntryElement(entry) {
            // ... (HTML æ¨¡æ¿å‰µå»ºé‚è¼¯ç¶­æŒä¸è®Š)
            const entryEl = document.createElement('div');
            entryEl.className = `memory-entry author-${entry.author} type-${entry.type}`;

            let bodyContent;
            let entryTypeLabel = entry.author + '\'s Log';
            let titleColor = entry.author === 'LL' ? '#fff' : 'var(--stardew-dark)';

            if (entry.type === 'photo' && entry.imageDataURL) {
                bodyContent = `
                    <div class="entry-body">
                        <div class="photo-slot">
                            <img src="${entry.imageDataURL}" alt="${entry.title}">
                        </div>
                        <div class="photo-caption" style="color:${titleColor}; font-size: 8px;">
                            **[${entry.title}]**<br>
                            ${entry.content}
                        </div>
                    </div>
                `;
            } else {
                bodyContent = `
                    <div class="entry-body">
                        <span style="display:block; font-size: 10px; margin-bottom: 5px; color:${titleColor};">**${entry.title}**</span>
                        ${entry.content}
                        ${entry.imageDataURL ? `<img src="${entry.imageDataURL}" style="max-width: 100%; margin-top: 10px; opacity: 0.8; border: 2px solid var(--stardew-dark); box-shadow: 2px 2px 0 0 var(--stardew-dark);">` : ''}
                    </div>
                `;
            }

            entryEl.innerHTML = `
                <div class="entry-header">
                    <span>${entryTypeLabel}</span>
                    <span style="display:flex; align-items:center;">
                        <span>${entry.date} â€¢ ${getWeatherName(entry.weather)} ${entry.weather}</span>
                        <button class="delete-btn" onclick="deleteEntry(${entry.id}, '${entry.dateStr}')">X DELETE</button>
                    </span>
                </div>
                ${bodyContent}
            `;
            return entryEl;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function getFormattedDate(dateObj, format) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');

            if (format === 'YYYY-MM-DD') return `${year}-${month}-${day}`;
            return `${year}/${month}/${day}`;
        }

        function getWeatherName(emoji) {
            switch(emoji) {
                case 'â˜€ï¸': return 'Sunny Day';
                case 'ğŸŒ§ï¸': return 'Rainy Day';
                case 'ğŸ’¨': return 'Windy Day';
                case 'â„ï¸': return 'Snowy Day';
                default: return 'Clear Day';
            }
        }
    </script>
</body>
</html>