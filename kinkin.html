<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardew Logbook - å”ä½œç‰ˆæ—¥èªŒ (v3.1)</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Stardew é¡è‰²è¨­å®š */
            --stardew-green: #4c7c34;
            --stardew-brown: #a0785a;
            --stardew-light-brown: #cfc29c;
            --stardew-cream: #fcfbe7;
            --stardew-dark: #2a2a2a;
            --stardew-red: #c94c4c;
            --stardew-gold: #ffc300;
            --stardew-blue: #5b7999; /* LL çš„é¡è‰² */
            --stardew-pink: #cc99a3; /* KK çš„é¡è‰² */
            --stardew-purple: #9a67a5; /* ç¸½çµçš„é¡è‰² */
            --pixel-size: 2px;
            --page-width: 800px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            image-rendering: pixelated;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--stardew-green);
            background-image: repeating-linear-gradient(45deg, var(--stardew-green) 0, var(--stardew-green) 10px, var(--stardew-dark) 10px, var(--stardew-dark) 11px),
                              repeating-linear-gradient(-45deg, var(--stardew-green) 0, var(--stardew-green) 10px, var(--stardew-dark) 10px, var(--stardew-dark) 11px);
            background-size: 20px 20px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            color: var(--stardew-dark);
        }

        /* --- æ›¸æœ¬å®¹å™¨ (Wrapper) --- */
        .journal-window {
            width: var(--page-width);
            height: 90vh;
            background-color: var(--stardew-cream);
            padding: 20px;
            position: relative;
            overflow: hidden;

            border: calc(var(--pixel-size) * 4) solid var(--stardew-brown);
            box-shadow:
                calc(var(--pixel-size) * 4) calc(var(--pixel-size) * 4) 0 0 var(--stardew-dark),
                calc(var(--pixel-size) * 8) calc(var(--pixel-size) * 8) 0 0 var(--stardew-light-brown),
                inset 0 0 0 2px var(--stardew-light-brown);
        }

        /* --- è¦–åœ–åˆ‡æ›å™¨ (ç”¨æ–¼å‹•ç•«) --- */
        #view-switcher {
             position: relative;
             height: calc(100% - 70px);
             perspective: 1500px;
        }

        #view-switcher > div {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            padding: 20px;
            background-color: var(--stardew-cream);
            transition: transform 0.6s ease-in-out, opacity 0.6s ease-in-out;
            transform-origin: left;
            overflow-y: auto;
            backface-visibility: hidden;
        }

        .view-hidden { opacity: 0; z-index: 10; pointer-events: none; transform: rotateY(-90deg); }
        .view-active { opacity: 1; z-index: 20; pointer-events: all; transform: rotateY(0deg); }

        /* --- é ‚éƒ¨ç‹€æ…‹æ¬„ --- */
        .stat-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0; border-bottom: var(--pixel-size) solid var(--stardew-dark); }
        .settings-btn { background-color: var(--stardew-light-brown); color: var(--stardew-dark); padding: 4px 8px; font-size: 10px; cursor: pointer; border: var(--pixel-size) solid var(--stardew-dark); box-shadow: 2px 2px 0 0 var(--stardew-dark); transition: all 0.1s; }
        .settings-btn:hover { background-color: var(--stardew-gold); transform: translate(-1px, -1px); }

        .love-value { font-size: 10px; background: var(--stardew-pink); padding: 4px 8px; color: #fff; border: var(--pixel-size) solid var(--stardew-dark); box-shadow: 2px 2px 0 0 var(--stardew-dark); }
        .stat-item { display: flex; align-items: center; font-size: 10px; }
        .stat-icon { font-size: 18px; margin-right: 5px; }

        /* --- æ—¥æ›†ç›¸é—œæ¨£å¼ --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-size: 10px; }
        .day-header { text-align: center; color: var(--stardew-brown); padding: 5px; }
        .day-cell { height: 80px; padding: 5px; text-align: right; cursor: pointer; position: relative; background-color: #fff; border: var(--pixel-size) solid var(--stardew-light-brown); box-shadow: 1px 1px 0 0 var(--stardew-light-brown); transition: background-color 0.1s, transform 0.1s; }
        .day-cell:not(.empty-cell):hover { background-color: var(--stardew-gold); transform: translate(-1px, -1px); }
        .empty-cell { background-color: #f0f0f0; cursor: default; border: none; box-shadow: none; }
        .has-entry { background-color: var(--stardew-pink); color: #fff; font-weight: bold; }

        /* æœˆæœ«ç¸½çµæ¨™è¨˜ */
        .is-month-end { border: 4px dashed var(--stardew-purple); font-weight: bold; }
        .is-month-end:hover { background-color: var(--stardew-purple) !important; color: #fff; }
        .is-month-end .count { background: var(--stardew-gold) !important; color: var(--stardew-dark); }

        .day-cell .count { position: absolute; top: 5px; left: 5px; font-size: 8px; background: rgba(0,0,0,0.2); padding: 1px 3px; border-radius: 2px; }

        /* --- å–®æ—¥é é¢ --- */
        .timeline-content { display: flex; flex-direction: column; gap: 20px; padding-top: 20px; }

        /* --- èŠå¤©æ°£æ³¡æ¨£å¼ --- */
        .memory-entry { width: 70%; padding: 15px; margin-bottom: 10px; transition: all 0.3s; position: relative; border: var(--pixel-size) solid var(--stardew-dark); box-shadow: var(--pixel-size) var(--pixel-size) 0 0 var(--stardew-dark); }
        .author-LL { margin-right: auto; background-color: var(--stardew-blue); color: #fff; }
        .author-KK { margin-left: auto; background-color: var(--stardew-pink); color: var(--stardew-dark); }

        /* --- æœˆæœ«ç¸½çµå…§å®¹é¡¯ç¤º --- */
        .entry-month-summary {
            width: 90%;
            margin: 20px auto;
            padding: 25px;
            background-color: var(--stardew-purple);
            color: #fff;
            border: 4px solid var(--stardew-dark);
            box-shadow: 6px 6px 0 0 var(--stardew-dark);
        }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .summary-header h3 { font-size: 14px; text-align: center; margin: 0; flex-grow: 1; }

        .summary-content-wrapper { display: flex; gap: 20px; }
        .summary-section-column { flex: 1; display: flex; flex-direction: column; }
        .summary-section { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed rgba(255, 255, 255, 0.3); }
        .summary-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .summary-section h4 { font-size: 9px; margin-bottom: 3px; color: var(--stardew-gold); }
        .summary-section p { font-size: 8px; line-height: 1.4; margin: 0; color: var(--stardew-cream); }

        /* --- Modal & Form Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 100; }
        .crafting-menu { width: 500px; background-color: var(--stardew-cream); padding: 30px; border: calc(var(--pixel-size) * 4) solid var(--stardew-brown); box-shadow: calc(var(--pixel-size) * 4) calc(var(--pixel-size) * 4) 0 0 var(--stardew-dark), calc(var(--pixel-size) * 8) calc(var(--pixel-size) * 8) 0 0 var(--stardew-light-brown); }
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .form-group { flex-grow: 1; display: flex; flex-direction: column; }
        .form-group label { font-size: 8px; margin-bottom: 5px; color: var(--stardew-brown); }
        .form-group input, .form-group select, .form-group textarea { padding: 5px; font-family: sans-serif; font-size: 12px; border: var(--pixel-size) solid var(--stardew-dark); }
        .form-group textarea { resize: vertical; min-height: 100px; }

        /* æœˆæœ«ç¸½çµè¡¨å–®ç‰¹åŒ– (æ ¸å¿ƒèª¿æ•´) */
        #summary-modal .crafting-menu { width: 700px; } /* åŠ å¯¬ Modal */
        #summary-form .form-group { margin-bottom: 10px; }
        #summary-form textarea { min-height: 60px; font-size: 11px; }

        .summary-form-section-wrapper { display: flex; gap: 15px; margin-bottom: 20px; } /* è®“å…©éƒ¨åˆ†ä¸¦æ’ */
        .summary-author-form-section {
            flex: 1;
            padding: 15px;
            border: var(--pixel-size) solid var(--stardew-dark);
            position: relative;
            background-color: #fff;
        }
        .summary-author-form-section h4 {
            font-size: 10px;
            text-align: center;
            background: var(--stardew-cream);
            padding: 5px;
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: fit-content;
            border: var(--pixel-size) solid var(--stardew-dark);
            box-shadow: 2px 2px 0 0 var(--stardew-dark);
        }
        .summary-author-form-section.ll-section h4 { color: var(--stardew-blue); }
        .summary-author-form-section.kk-section h4 { color: var(--stardew-pink); }

        /* --- çµ±ä¸€çš„åƒç´ é¢¨æ ¼æŒ‰éˆ• (btn-pixel) --- */
        .btn-pixel {
            background-color: var(--stardew-light-brown);
            color: var(--stardew-dark);
            padding: 8px 12px;
            font-size: 10px;
            cursor: pointer;
            border: var(--pixel-size) solid var(--stardew-dark);
            box-shadow: 2px 2px 0 0 var(--stardew-dark);
            transition: all 0.1s;
            line-height: 1;
        }
        .btn-pixel:hover { background-color: var(--stardew-gold); color: var(--stardew-dark); box-shadow: 3px 3px 0 0 var(--stardew-dark); transform: translate(-1px, -1px); }
        .btn-pixel:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0 0 var(--stardew-dark); }

        .add-btn { position: fixed; bottom: 30px; right: 30px; width: 120px; height: 40px; line-height: 20px; text-align: center; background-color: var(--stardew-gold); color: var(--stardew-dark); cursor: pointer; z-index: 50; }

        .file-upload-btn { background-color: var(--stardew-blue); color: #fff; padding: 8px 12px; font-size: 10px; cursor: pointer; border: var(--pixel-size) solid var(--stardew-dark); box-shadow: 2px 2px 0 0 var(--stardew-dark); display: inline-block; margin-top: 5px; }
        .file-upload-btn:hover { background-color: #4a6785; }
        #entry-image { display: none; }

        /* è¿”å›æŒ‰éˆ•çš„çµ±ä¸€é¢¨æ ¼ */
        .back-btn {
            position: absolute; top: 5px; left: 25px;
            z-index: 30;
            background-color: var(--stardew-light-brown);
            color: var(--stardew-dark);
            padding: 5px 8px;
            font-size: 10px;
            cursor: pointer;
            border: var(--pixel-size) solid var(--stardew-dark);
            box-shadow: 2px 2px 0 0 var(--stardew-dark);
            transition: all 0.1s;
            line-height: 1;
        }
        .back-btn:hover { background-color: var(--stardew-gold); transform: translate(-1px, -1px); }
        .back-btn:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0 0 var(--stardew-dark); }

        /* åˆªé™¤æŒ‰éˆ•çš„çµ±ä¸€é¢¨æ ¼ */
        .delete-btn {
            background-color: var(--stardew-red);
            color: #fff;
            font-size: 8px;
            padding: 2px 5px;
            margin-left: 10px;
            border: var(--pixel-size) solid var(--stardew-dark);
            cursor: pointer;
            box-shadow: 1px 1px 0 0 var(--stardew-dark);
            transition: background-color 0.1s;
            line-height: 1;
        }
        .delete-btn:hover { background-color: darkred; box-shadow: 2px 2px 0 0 var(--stardew-dark); }
        .delete-btn:active { transform: translate(1px, 1px); box-shadow: 0 0 0 0 var(--stardew-dark); }

    </style>
</head>
<body>

    <div class="journal-window">

        <div class="stat-bar">
             <button class="settings-btn" onclick="openSettingsModal()">âš™ï¸ SETTINGS</button>
            <div class="love-value" id="love-value">
                â¤ï¸ LOVE: 0
            </div>
            <div class="stat-item">
                <span class="stat-icon">ğŸ“…</span>
                <span style="font-size: 8px;" id="current-date"></span>
            </div>
        </div>

        <div id="view-switcher">

            <div id="calendar-view" class="view-active">
                <header style="text-align: center; margin-bottom: 30px;">
                    <h1 style="font-size: 20px; margin: 0; color: var(--stardew-dark);">CALENDAR</h1>
                    <div id="current-month-year"></div>
                </header>
                <div class="calendar-grid" id="calendar-grid">
                    </div>
            </div>

            <div id="day-view" class="view-hidden">
                <button class="back-btn" onclick="navigateTo('calendar')">â† BACK</button>
                <h2 id="day-title"></h2>
                <div class="timeline-content" id="day-timeline-content">
                    </div>
            </div>

        </div>

    </div>

    <button class="add-btn btn-pixel" onclick="openForm()">+ NEW LOG</button>

    <div class="modal-overlay" id="crafting-modal">
        <div class="crafting-menu">
            <h2>CRAFT NEW ENTRY</h2>
            <form id="entry-form">

                <div class="form-row">
                    <div class="form-group"><label for="entry-author">RECORDER (è¨˜äº‹äºº)</label><select id="entry-author" required><option value="LL">LL</option><option value="KK">KK</option></select></div>
                    <div class="form-group"><label for="entry-date">DATE (æ—¥æœŸ)</label><input type="date" id="entry-date" required></div>
                </div>

                <div class="form-row">
                    <div class="form-group"><label for="entry-weather">WEATHER (å¤©æ°£)</label>
                        <select id="entry-weather" required>
                            <option value="â˜€ï¸">æ™´å¤© (Sunny) â˜€ï¸</option>
                            <option value="â˜ï¸">å¤šé›² (Cloudy) â˜ï¸</option>
                            <option value="ğŸ’¨">é¢³é¢¨ (Windy) ğŸ’¨</option>
                            <option value="ğŸŒ§ï¸">ä¸‹é›¨ (Rainy) ğŸŒ§ï¸</option>
                            <option value="â„ï¸">ä¸‹é›ª (Snowy) â„ï¸</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="entry-mood">MOOD (å¿ƒæƒ…)</label>
                        <select id="entry-mood" required>
                            <option value="ğŸ˜„">é–‹å¿ƒ (Happy)</option>
                            <option value="ğŸ™‚">å¹³éœ (Calm)</option>
                            <option value="ğŸ˜¥">é›£é (Sad)</option>
                            <option value="ğŸ˜¡">ç”Ÿæ°£ (Angry)</option>
                            <option value="ğŸ˜´">ç–²æ†Š (Tired)</option>
                            <option value="âœ¨">èˆˆå¥® (Excited)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex-grow: 2;"><label for="entry-title">TITLE / SHORT CAPTION (æ¨™é¡Œ)</label><input type="text" id="entry-title" required maxlength="50"></div>
                    <div class="form-group"><label for="entry-type">ENTRY TYPE (å½¢å¼)</label>
                        <select id="entry-type" required onchange="toggleContentRequired()">
                            <option value="text">TEXT LOG (æ–‡å­—)</option>
                            <option value="photo">PHOTO MEMORY (åœ–ç‰‡)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="content-text-group">
                    <label for="entry-content">MAIN CONTENT (ä¸»è¦å…§å®¹)</label>
                    <textarea id="entry-content" required></textarea>
                </div>

                <div class="form-group" id="file-upload-group">
                    <label for="entry-image">ATTACH PHOTO (åœ–ç‰‡æª”æ¡ˆ)</label>
                    <label for="entry-image" class="file-upload-btn" id="file-label" style="width: 100%; text-align: center;">CLICK TO SELECT FILE ğŸ“·</label>
                    <input type="file" id="entry-image" accept="image/*">
                </div>

                <div class="form-actions" style="display:flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-pixel" onclick="closeForm()">CLOSE</button>
                    <button type="submit" class="btn-pixel" style="background-color: var(--stardew-green); color:#fff;">LOG IT!</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="crafting-menu" style="width: 450px;">
            <h2>SETTINGS / DATA TRANSFER</h2>
             <div class="setting-option">
                <h3>EXPORT LOGS (åŒ¯å‡ºæ—¥èªŒ)</h3>
                <p>å°‡æ‰€æœ‰æ—¥èªŒå…§å®¹æ‰“åŒ…æˆä¸€å€‹ `.json` æª”æ¡ˆã€‚é€™æ˜¯æ‚¨èˆ‡å”ä½œè€…å…±äº«é€²åº¦çš„æ–¹å¼ã€‚</p>
                <button class="btn-pixel" style="background-color: var(--stardew-gold); color: var(--stardew-dark);" onclick="exportLogs()">DOWNLOAD .JSON</button>
            </div>

            <div class="setting-option">
                <h3>IMPORT LOGS (åŒ¯å…¥æ—¥èªŒ)</h3>
                <p>ä¸Šå‚³ä¸€å€‹ `.json` æª”æ¡ˆä¾†è¦†è“‹æœ¬åœ°å„²å­˜çš„æ—¥èªŒã€‚**è­¦å‘Šï¼šé€™å°‡å–ä»£æ‚¨æ‰€æœ‰çš„æœ¬åœ°ç´€éŒ„ï¼**</p>
                <input type="file" id="import-file-input" accept=".json">
                <label for="import-file-input" class="file-upload-btn">
                    UPLOAD & IMPORT FILE
                </label>
            </div>

            <div class="setting-option">
                <h3>WIPE ALL DATA (æ¸…é™¤æ•¸æ“š)</h3>
                <p>å¦‚æœæ‚¨æƒ³å¾é ­é–‹å§‹æˆ–æ¸…ç†æœ¬åœ°å„²å­˜ï¼Œè«‹é»æ“Šæ­¤è™•ã€‚**æ­¤æ“ä½œä¸å¯é€†ï¼**</p>
                <button type="button" class="btn-pixel" style="background-color: var(--stardew-red); color: #fff;" onclick="wipeData()">WIPE LOCAL DATA</button>
            </div>

            <div class="form-actions" style="display:flex; justify-content: end; margin-top: 20px;">
                <button type="button" class="btn-pixel" onclick="closeSettingsModal()">CLOSE</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="summary-modal">
        <div class="crafting-menu" style="width: 700px;">
            <h2 id="summary-month-title" style="text-align: center;"></h2>
            <form id="summary-form">

                <div class="summary-form-section-wrapper">
                    <div class="summary-author-form-section ll-section">
                        <h4>LL'S SECTION</h4>
                        <div class="form-group"><label>æœ¬æœˆå¾©ç›¤ (LL)</label><textarea id="summary-ll-review" required></textarea></div>
                        <div class="form-group"><label>å¾…æ”¹é€² (LL)</label><textarea id="summary-ll-improve" required></textarea></div>
                        <div class="form-group"><label>å° KK çš„æœŸå¾… (LL)</label><textarea id="summary-ll-expect" required></textarea></div>
                    </div>

                    <div class="summary-author-form-section kk-section">
                        <h4>KK'S SECTION</h4>
                        <div class="form-group"><label>æœ¬æœˆå¾©ç›¤ (KK)</label><textarea id="summary-kk-review" required></textarea></div>
                        <div class="form-group"><label>å¾…æ”¹é€² (KK)</label><textarea id="summary-kk-improve" required></textarea></div>
                        <div class="form-group"><label>å° LL çš„æœŸå¾… (KK)</label><textarea id="summary-kk-expect" required></textarea></div>
                    </div>
                </div>

                <div class="form-actions" style="display:flex; justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn-pixel" onclick="closeSummaryModal()">CLOSE</button>
                    <button type="submit" class="btn-pixel" style="background-color: var(--stardew-purple); color:#fff;">SUBMIT SUMMARY</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- Setup & Global Variables ---
        const MODAL = document.getElementById('crafting-modal');
        const SETTINGS_MODAL = document.getElementById('settings-modal');
        const SUMMARY_MODAL = document.getElementById('summary-modal');
        const FORM = document.getElementById('entry-form');
        const SUMMARY_FORM = document.getElementById('summary-form');
        const CALENDAR_GRID = document.getElementById('calendar-grid');
        const DAY_TIMELINE = document.getElementById('day-timeline-content');
        const CALENDAR_VIEW = document.getElementById('calendar-view');
        const DAY_VIEW = document.getElementById('day-view');

        const FILE_INPUT = document.getElementById('entry-image');
        const FILE_LABEL = document.getElementById('file-label');
        const IMPORT_FILE_INPUT = document.getElementById('import-file-input');

        const ENTRY_TYPE_SELECT = document.getElementById('entry-type');
        const CONTENT_TEXTAREA = document.getElementById('entry-content');
        const CONTENT_TEXT_GROUP = document.getElementById('content-text-group');

        const STORAGE_KEY = 'stardewFarmLogEntriesV3';
        const SUMMARY_TYPE = 'month_summary';
        let allEntries = [];
        const LOVE_VALUE_PER_ENTRY = 5;

        let currentDisplayYear;
        let currentDisplayMonth;
        let currentSummaryDateStr = null;


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            currentDisplayYear = today.getFullYear();
            currentDisplayMonth = today.getMonth();

            document.getElementById('current-date').textContent = getFormattedDate(today, 'YYYY/MM/DD');
            loadAndRenderAll();
            navigateTo('calendar');

            IMPORT_FILE_INPUT.addEventListener('change', importLogs);

            FORM.addEventListener('submit', handleEntrySubmit);
            SUMMARY_FORM.addEventListener('submit', handleSummarySubmit);
        });

        function loadAndRenderAll() {
            allEntries = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            calculateLoveValue();
            renderCalendar();
        }

        function calculateLoveValue() {
            const logEntries = allEntries.filter(e => e.type !== SUMMARY_TYPE);
            const totalLove = logEntries.length * LOVE_VALUE_PER_ENTRY;
            document.getElementById('love-value').textContent = `â¤ï¸ LOVE: ${totalLove}`;
        }

        // --- è¦–åœ–åˆ‡æ›èˆ‡å°èˆª ---
        function navigateTo(view, dateStr = null) {
            if (view === 'day' && dateStr) {
                renderDayView(dateStr);
                CALENDAR_VIEW.classList.remove('view-active');
                CALENDAR_VIEW.classList.add('view-hidden');
                DAY_VIEW.classList.remove('view-hidden');
                DAY_VIEW.classList.add('view-active');

            } else if (view === 'calendar') {
                const today = new Date();
                document.getElementById('current-date').textContent = getFormattedDate(today, 'YYYY/MM/DD');

                // åªæœ‰åœ¨å›åˆ°æ—¥æ›†æ™‚æ‰é‡ç½®åˆ°ç•¶å‰æœˆä»½
                currentDisplayYear = today.getFullYear();
                currentDisplayMonth = today.getMonth();
                renderCalendar();

                DAY_VIEW.classList.remove('view-active');
                DAY_VIEW.classList.add('view-hidden');
                CALENDAR_VIEW.classList.remove('view-hidden');
                CALENDAR_VIEW.classList.add('view-active');
            }
        }

        function prevMonth() { currentDisplayMonth--; if (currentDisplayMonth < 0) { currentDisplayMonth = 11; currentDisplayYear--; } renderCalendar(); }
        function nextMonth() { currentDisplayMonth++; if (currentDisplayMonth > 11) { currentDisplayMonth = 0; currentDisplayYear++; } renderCalendar(); }
        window.prevMonth = prevMonth;
        window.nextMonth = nextMonth;

        // --- æ—¥æ›†æ¸²æŸ“ ---
        function renderCalendar() {
            const year = currentDisplayYear;
            const month = currentDisplayMonth;

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const lastDayDateKey = getFormattedDate(new Date(year, month, daysInMonth), 'YYYY-MM-DD');

            const entriesByDate = allEntries.reduce((acc, entry) => {
                const dateKey = entry.dateStr;
                if (!acc[dateKey]) acc[dateKey] = { logs: 0, summary: false };
                if (entry.type === SUMMARY_TYPE) {
                    acc[dateKey].summary = true;
                } else {
                    acc[dateKey].logs++;
                }
                return acc;
            }, {});

            document.getElementById('current-month-year').innerHTML = `
                <button class="calendar-nav-btn" onclick="prevMonth()">â†</button>
                ${year} / ${month + 1}
                <button class="calendar-nav-btn" onclick="nextMonth()">â†’</button>
            `;

            CALENDAR_GRID.innerHTML = '';

            const firstDayOfWeek = new Date(year, month, 1).getDay();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            dayNames.forEach(day => { const header = document.createElement('div'); header.className = 'day-header'; header.textContent = day; CALENDAR_GRID.appendChild(header); });
            for (let i = 0; i < firstDayOfWeek; i++) { const empty = document.createElement('div'); empty.className = 'empty-cell'; CALENDAR_GRID.appendChild(empty); }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateKey = getFormattedDate(date, 'YYYY-MM-DD');
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.textContent = day;
                cell.dataset.date = dateKey;

                const dayData = entriesByDate[dateKey] || { logs: 0, summary: false };

                if (dayData.logs > 0 || dayData.summary) {
                    cell.classList.add('has-entry');
                    const countSpan = document.createElement('span');
                    const totalCount = dayData.logs + (dayData.summary ? 1 : 0);
                    countSpan.className = 'count';
                    countSpan.textContent = `${totalCount} Log${totalCount > 1 ? 's' : ''}`;
                    cell.appendChild(countSpan);
                }

                // åˆ¤æ–·æ˜¯å¦ç‚ºæœˆæœ«ç¸½çµæ—¥
                if (dateKey === lastDayDateKey) {
                    cell.classList.add('is-month-end');
                    cell.onclick = (function(key, hasSummary) {
                        return function() {
                            if (dayData.summary) {
                                navigateTo('day', key);
                            } else {
                                openSummaryModal(key);
                            }
                        };
                    })(dateKey, dayData.summary);

                } else {
                    cell.onclick = (function(key) { return function() { navigateTo('day', key); }; })(dateKey);
                }

                CALENDAR_GRID.appendChild(cell);
            }
        }

        // --- å–®æ—¥å…§å®¹æ¸²æŸ“ ---
        function renderDayView(dateStr) {
            document.getElementById('day-title').textContent = `LOGS FOR ${dateStr}`;
            DAY_TIMELINE.innerHTML = '';
            const dateObj = new Date(dateStr + 'T00:00:00');
            document.getElementById('current-date').textContent = getFormattedDate(dateObj, 'YYYY/MM/DD');

            const dayEntries = allEntries.filter(e => e.dateStr === dateStr)
                                       .sort((a, b) => b.id - a.id);

            if (dayEntries.length === 0) {
                DAY_TIMELINE.innerHTML = '<p style="text-align:center; font-size:10px; padding-top: 50px;">NO ENTRIES FOR THIS DATE. BE THE FIRST TO LOG!</p>';
                return;
            }

            dayEntries.forEach(entry => {
                DAY_TIMELINE.appendChild(createEntryElement(entry));
            });
        }

        // --- åˆªé™¤åŠŸèƒ½ ---
        function deleteEntry(id, dateStr) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™æ¢æ—¥èªŒå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚")) { return; }
            allEntries = allEntries.filter(entry => entry.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allEntries));
            calculateLoveValue();
            // åˆ¤æ–·ç•¶å‰æ˜¯å¦é‚„åœ¨æ—¥èªŒé é¢ï¼Œæ˜¯å‰‡åˆ·æ–°
            if (DAY_VIEW.classList.contains('view-active')) {
                renderDayView(dateStr);
            }
            renderCalendar();
        }
        window.deleteEntry = deleteEntry;


        // --- è¡¨å–®é‚è¼¯ï¼šæ™®é€šæ—¥èªŒ ---

        function toggleContentRequired() {
            if (ENTRY_TYPE_SELECT.value === 'photo') {
                CONTENT_TEXTAREA.removeAttribute('required');
                CONTENT_TEXT_GROUP.style.opacity = '0.5';
                CONTENT_TEXT_GROUP.style.pointerEvents = 'none';
                FILE_INPUT.setAttribute('required', 'required');
            } else {
                CONTENT_TEXTAREA.setAttribute('required', 'required');
                CONTENT_TEXT_GROUP.style.opacity = '1';
                CONTENT_TEXT_GROUP.style.pointerEvents = 'all';
                FILE_INPUT.removeAttribute('required');
            }
        }
        window.toggleContentRequired = toggleContentRequired;

        function openForm() {
            MODAL.style.display = 'flex';
            FORM.reset();
            FILE_LABEL.textContent = 'CLICK TO SELECT FILE ğŸ“·';
            document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
            toggleContentRequired();
        }
        function closeForm() { MODAL.style.display = 'none'; }

        FILE_INPUT.addEventListener('change', (e) => {
            FILE_LABEL.textContent = e.target.files.length > 0 ? `File Selected: ${e.target.files[0].name}` : 'CLICK TO SELECT FILE ğŸ“·';
        });

        async function handleEntrySubmit(e) {
            e.preventDefault();

            const dateInput = document.getElementById('entry-date').value;
            const entryType = ENTRY_TYPE_SELECT.value;
            const file = FILE_INPUT.files[0];
            let imageDataURL = null;

            if (entryType === 'photo' && !file && FILE_INPUT.hasAttribute('required')) {
                alert("åœ–ç‰‡æ¨¡å¼éœ€è¦ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆã€‚");
                return;
            }

            if (file) {
                imageDataURL = await fileToBase64(file);
            }

            const newEntry = {
                id: Date.now(),
                author: document.getElementById('entry-author').value,
                dateStr: dateInput,
                date: getFormattedDate(new Date(dateInput), 'YYYY/MM/DD'),
                weather: document.getElementById('entry-weather').value,
                mood: document.getElementById('entry-mood').value,
                title: document.getElementById('entry-title').value,
                content: document.getElementById('entry-content').value,
                type: entryType,
                imageDataURL: imageDataURL,
            };

            saveEntry(newEntry);
            loadAndRenderAll();
            navigateTo('day', newEntry.dateStr);
            closeForm();
        }

        function saveEntry(newEntry) {
            allEntries.push(newEntry);
            allEntries.sort((a, b) => a.id - b.id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allEntries));
        }


        // --- è¡¨å–®é‚è¼¯ï¼šæœˆæœ«ç¸½çµ ---

        function openSummaryModal(dateStr) {
            const dateObj = new Date(dateStr + 'T00:00:00');
            const month = dateObj.getMonth() + 1;
            const year = dateObj.getFullYear();

            currentSummaryDateStr = dateStr;
            document.getElementById('summary-month-title').textContent = `${year} / ${month} æœˆæœ«ç¸½çµ`;

            SUMMARY_FORM.reset();
            SUMMARY_MODAL.style.display = 'flex';
        }

        function closeSummaryModal() {
            SUMMARY_MODAL.style.display = 'none';
        }

        function handleSummarySubmit(e) {
            e.preventDefault();

            if (!currentSummaryDateStr) return;

            const date = new Date(currentSummaryDateStr + 'T00:00:00');
            const newSummaryEntry = {
                id: Date.now(),
                dateStr: currentSummaryDateStr,
                date: getFormattedDate(date, 'YYYY/MM/DD'),
                type: SUMMARY_TYPE,

                llReview: document.getElementById('summary-ll-review').value,
                llImprove: document.getElementById('summary-ll-improve').value,
                llExpect: document.getElementById('summary-ll-expect').value,

                kkReview: document.getElementById('summary-kk-review').value,
                kkImprove: document.getElementById('summary-kk-improve').value,
                kkExpect: document.getElementById('summary-kk-expect').value,
            };

            saveEntry(newSummaryEntry);
            loadAndRenderAll();
            navigateTo('day', newSummaryEntry.dateStr);
            closeSummaryModal();
        }


        // --- æ ¸å¿ƒï¼šåŒ¯å‡º/åŒ¯å…¥/æ¸…é™¤ åŠŸèƒ½ ---

        function openSettingsModal() { SETTINGS_MODAL.style.display = 'flex'; }
        function closeSettingsModal() { SETTINGS_MODAL.style.display = 'none'; }
        window.openSettingsModal = openSettingsModal;

        function exportLogs() {
            const data = JSON.stringify(allEntries, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            const date = getFormattedDate(new Date(), 'YYYY-MM-DD');
            a.download = `stardew_log_export_${date}.json`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("æ—¥èªŒå·²æˆåŠŸåŒ¯å‡ºç‚º JSON æª”æ¡ˆï¼è«‹å°‡æ­¤æª”æ¡ˆç™¼é€çµ¦æ‚¨çš„å”ä½œè€…ã€‚");
        }
        window.exportLogs = exportLogs;

        function importLogs(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("ç¢ºå®šè¦åŒ¯å…¥æ–°çš„æ—¥èªŒå—ï¼Ÿç¾æœ‰çš„æœ¬åœ°ç´€éŒ„å°‡æœƒè¢«æ–°çš„æª”æ¡ˆæ•¸æ“šè¦†è“‹ã€‚")) {
                event.target.value = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (Array.isArray(importedData)) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
                        loadAndRenderAll();
                        closeSettingsModal();
                        alert(`æ—¥èªŒæˆåŠŸåŒ¯å…¥ï¼å…±è¼‰å…¥ ${importedData.length} æ¢ç´€éŒ„ã€‚`);
                    } else {
                        alert("éŒ¯èª¤ï¼šåŒ¯å…¥çš„æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ç¢ºèªæ‚¨åŒ¯å…¥çš„æ˜¯æ­£ç¢ºçš„æ—¥èªŒ JSON æª”æ¡ˆã€‚");
                    }
                } catch (error) {
                    console.error("Error parsing JSON:", error);
                    alert("éŒ¯èª¤ï¼šè®€å–æª”æ¡ˆå¤±æ•—æˆ– JSON æ ¼å¼ç„¡æ•ˆã€‚");
                } finally {
                    event.target.value = null;
                }
            };
            reader.readAsText(file);
        }

        function wipeData() {
            if (!confirm("è­¦å‘Šï¼šæ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰çš„æœ¬åœ°æ—¥èªŒæ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰ç´€éŒ„ï¼Œç„¡æ³•å¾©åŸï¼è«‹ç¢ºèªæ‚¨å·²åŒ¯å‡ºå‚™ä»½ã€‚")) {
                return;
            }
            localStorage.removeItem(STORAGE_KEY);
            allEntries = [];
            loadAndRenderAll();
            navigateTo('calendar');
            closeSettingsModal();
            alert("æœ¬åœ°æ—¥èªŒæ•¸æ“šå·²å®Œå…¨æ¸…é™¤ã€‚æ‚¨å¯ä»¥é–‹å§‹æ–°çš„ç´€éŒ„æˆ–åŒ¯å…¥å‚™ä»½ã€‚");
        }
        window.wipeData = wipeData;

        // --- Rendering Templates & Utilities ---
        function createEntryElement(entry) {
            if (entry.type === SUMMARY_TYPE) {
                return createSummaryElement(entry);
            }

            const entryEl = document.createElement('div');
            entryEl.className = `memory-entry author-${entry.author} type-${entry.type}`;

            let bodyContent;
            let entryTypeLabel = entry.author + '\'s Log';
            let titleColor = entry.author === 'LL' ? '#fff' : 'var(--stardew-dark)';
            let contentDisplay = entry.content.trim() === '' ? 'ï¼ˆç„¡æ–‡å­—æè¿°ï¼‰' : entry.content;


            if (entry.type === 'photo') {
                // åœ–ç‰‡æ¨¡å¼
                bodyContent = `
                    <div class="entry-body">
                        <div style="font-size: 10px; text-align: center; margin-bottom: 10px; color:${titleColor};">
                            **[${entry.title}]**
                        </div>
                        ${entry.imageDataURL ? `<img src="${entry.imageDataURL}" style="max-width: 100%; border: 4px solid ${entry.author === 'LL' ? '#fff' : 'var(--stardew-dark)'}; box-shadow: 4px 4px 0 0 var(--stardew-dark);">` : '<p style="text-align:center;">ï¼ˆåœ–ç‰‡æœªè¼‰å…¥æˆ–éŒ¯èª¤ï¼‰</p>'}
                    </div>
                `;
            } else {
                // æ–‡å­—æ¨¡å¼
                bodyContent = `
                    <div class="entry-body" style="font-size: 10px; line-height: 1.5;">
                        <span style="display:block; font-size: 12px; margin-bottom: 5px; color:${titleColor};">**${entry.title}**</span>
                        ${contentDisplay}
                    </div>
                `;
            }

            entryEl.innerHTML = `
                <div class="entry-header" style="display: flex; justify-content: space-between; align-items: center; font-size: 8px; margin-bottom: 5px;">
                    <span>${entryTypeLabel} â€¢ ${getMoodName(entry.mood)} ${entry.mood}</span>
                    <span style="display:flex; align-items:center;">
                        <span>${entry.date} â€¢ ${getWeatherName(entry.weather)} ${entry.weather}</span>
                        <button class="delete-btn" onclick="deleteEntry(${entry.id}, '${entry.dateStr}')">X</button>
                    </span>
                </div>
                ${bodyContent}
            `;
            return entryEl;
        }

        // æ¸²æŸ“æœˆæœ«ç¸½çµæ¢ç›®
        function createSummaryElement(entry) {
            const summaryEl = document.createElement('div');
            summaryEl.className = 'entry-month-summary';

            summaryEl.innerHTML = `
                <div class="summary-header">
                    <h3>ğŸ“… ${entry.date.substring(0, 7)} æœˆæœ«ç¸½çµ ğŸ¤</h3>
                    <button class="delete-btn" onclick="deleteEntry(${entry.id}, '${entry.dateStr}')">X DELETE</button>
                </div>

                <div class="summary-content-wrapper">
                    <div class="summary-section-column" style="border-right: 1px dashed rgba(255, 255, 255, 0.2);">
                        <h4 style="color: var(--stardew-blue); font-size: 10px; border-bottom: 1px solid var(--stardew-blue); padding-bottom: 5px;">LL'S THOUGHTS</h4>
                        <div class="summary-section">
                            <h4>æœ¬æœˆå¾©ç›¤ï¼š</h4><p>${entry.llReview}</p>
                        </div>
                        <div class="summary-section">
                            <h4>å¾…æ”¹é€²ï¼š</h4><p>${entry.llImprove}</p>
                        </div>
                        <div class="summary-section">
                            <h4>å° KK çš„æœŸå¾…ï¼š</h4><p>${entry.llExpect}</p>
                        </div>
                    </div>

                    <div class="summary-section-column">
                        <h4 style="color: var(--stardew-pink); font-size: 10px; border-bottom: 1px solid var(--stardew-pink); padding-bottom: 5px;">KK'S THOUGHTS</h4>
                        <div class="summary-section">
                            <h4>æœ¬æœˆå¾©ç›¤ï¼š</h4><p>${entry.kkReview}</p>
                        </div>
                        <div class="summary-section">
                            <h4>å¾…æ”¹é€²ï¼š</h4><p>${entry.kkImprove}</p>
                        </div>
                        <div class="summary-section">
                            <h4>å° LL çš„æœŸå¾…ï¼š</h4><p>${entry.kkExpect}</p>
                        </div>
                    </div>
                </div>
            `;
            return summaryEl;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function getFormattedDate(dateObj, format) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');

            if (format === 'YYYY-MM-DD') return `${year}-${month}-${day}`;
            return `${year}/${month}/${day}`;
        }

        function getWeatherName(emoji) {
            switch(emoji) {
                case 'â˜€ï¸': return 'æ™´å¤©';
                case 'â˜ï¸': return 'å¤šé›²';
                case 'ğŸ’¨': return 'é¢³é¢¨';
                case 'ğŸŒ§ï¸': return 'ä¸‹é›¨';
                case 'â„ï¸': return 'ä¸‹é›ª';
                default: return 'æ™´å¤©';
            }
        }

        function getMoodName(emoji) {
            switch(emoji) {
                case 'ğŸ˜„': return 'é–‹å¿ƒ';
                case 'ğŸ™‚': return 'å¹³éœ';
                case 'ğŸ˜¥': return 'é›£é';
                case 'ğŸ˜¡': return 'ç”Ÿæ°£';
                case 'ğŸ˜´': return 'ç–²æ†Š';
                case 'âœ¨': return 'èˆˆå¥®';
                default: return 'å¹³éœ';
            }
        }
    </script>
</body>
</html>